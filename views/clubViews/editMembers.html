<% include ../layout/header %>
<div id="topDiv" style="position: fixed; z-index: 9; width: 100%; height: 80%; display: none; color: white; align-self: center; font-size: 20px; overflow-y: scroll;">
</div>

<div class="container">
  <h2>Members of <%= name %></h2>
  <p></p>            
  <table class="table">
    <thead>
      <tr>
        	<th style="width: 10%;"></th>
			<th style="width: 30%;">Name</th>
			<th style="width: 20%;">Role</th>
			<th style="width: 20%;">Rating</th>
			<th style="width: 20%;">Review</th>
      </tr>
    </thead>
    <tbody>
      	<% members.forEach(function(member, index) { %>
			<tr id="<%= member._id %>">
				<td>#<%= index %></td>
				<td>
				<%= member.name %>
				</td>
				<td>
				<%= member.role %>
				</td>
				<td>
				<div rating="<%= member.rating %>">
					<% include ../layout/rating %>
				</div>
				</td>
				<td class="reviewElement">
					<p class="reviewClass" onclick="editReview('<%=member.name%>', '<%=member._id%>', '<%=member.review%>')" style="text-overflow: ellipsis; max-width: 100px;white-space: nowrap;overflow: hidden;"><%= member.review %></p>
				</td>
			</tr>
		<% }) %>
    </tbody>
  </table>
</div>
<link href="/css/rating.css" rel="stylesheet">
<script type="text/javascript">
	
	$(".ratingLabel").click(function(){
		$(this).parent().find("input").nextAll().css({"color": "#ddd"});
	  	$(this).css({"color": "#FFD700"});
	  	$(this).nextAll().css({"color": "#FFD700"});
	  	//.rating > input:checked ~ label, /* show gold star when clicked */
	  	var myelement = $(this).prev();
	  	var rating = myelement.val();
	  	var fieldset = myelement.parent();
	  	var memberID = fieldset.parent().parent().parent().attr('id');
	  	console.log(memberID)
		$.post('/clubs/rateMember/'+memberID+'/'+rating, function(data) {
			myelement.val(data);
			console.log("new rating: "+data)
			fieldset.parent().attr('rating', data);
		});
	});
	$("fieldset").each(function(i) {
	  	var rating = $(this).parent().attr('rating');
	    console.log(rating);
	    if(!rating)
	    	rating="0";
	    var inputElement = $(this).find("[value="+rating+"]");
	    $(this).find("input").nextAll().css({"color": "#ddd"});
	    inputElement.css({"color": "#FFD700"});
	  	inputElement.nextAll().css({"color": "#FFD700"});
	    // console.log($(this).find("[value="+rating+"]").val());
	 });
	var editReview = function(name, id, review) {
		var html = '<div id="reviewDiv" style=\"position: fixed; align-self: center; margin-top: 50px; margin-left: 30%; width: 500px; height: 300px;\">'
			+	'<h3 style=\"color: white;\">Review of '+name+'</h3><hr>'
			+	'<textarea id=\"newReview\" style=\"width: 100%; height: 80%; color: black;\" placeholder=\"'+review+'\"></textarea>'
			+	'<div style=\"float: right;\">'
			+	'<button class=\"btn cancelBtn\" style=\"margin-right: 10px;\">Cancel</button>'
			+	'<button class=\"btn btn-success\" onclick=\"editReviewOf(\''+id+'\')\">Submit</button>'
			+	'</div></div>';
		$('#topDiv').html(html);
		$('#backgroundDiv').show();
	    $('#topDiv').show();
	}

	$('.cancelBtn').click(function() {
		$('#topDiv').hide();
		$('#backgroundDiv').hide();	
	});

	var editReviewOf = function(id) {
		var newReview = $('#newReview').val();
		console.log(newReview)
		$.post('/clubs/editReview/'+id+'/'+newReview, function(data) {
			if(data.edited=="true") {
				$('#'+id).find('.reviewClass').text(newReview);
				$('#backgroundDiv').hide();
	    		$('#topDiv').hide();
			} else {
				alert("not updated!")
			}
		});
	}

	$(document).mouseup(function (e) {
	    var container = $("#reviewDiv");
	    if (!container.is(e.target) 
	        && container.has(e.target).length === 0) {
	        container.hide();
	        $('#backgroundDiv').hide();
	        $('#topDiv').hide();
	    }
	});

	$(document).keyup(function(e) {
	  if (e.keyCode === 27) {
			$('#backgroundDiv').hide();
			$('#topDiv').hide();
	  }
	});
</script>
<style type="text/css">
	.reviewClass:hover {
		cursor: pointer;
		color: #18BC9C;
		text-decoration: underline;
	}
</style>

<% include ../layout/footer %>
